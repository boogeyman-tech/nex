<?php

namespace App\Modules\AssetVulnerability\Repository;

use App\Modules\AssetVulnerability\Entity\Vulnerability;
use App\Modules\AssetDiscovery\Entity\Asset;
use App\Entity\User;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * @extends ServiceEntityRepository<Vulnerability>
 */
class VulnerabilityRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, Vulnerability::class);
    }

    /**
     * Find vulnerabilities for a specific user's assets
     */
    public function findByUser(User $user, array $orderBy = ['discoveredAt' => 'DESC']): array
    {
        return $this->createQueryBuilder('v')
            ->join('v.asset', 'a')
            ->where('a.user = :user')
            ->setParameter('user', $user)
            ->orderBy('v.' . array_key_first($orderBy), array_values($orderBy)[0])
            ->getQuery()
            ->getResult();
    }

    /**
     * Find vulnerabilities accessible by a user (user's assets + admin can see all)
     */
    public function findAccessibleByUser(User $user, array $orderBy = ['discoveredAt' => 'DESC']): array
    {
        if ($user->isAdmin()) {
            return $this->findAll($orderBy);
        }
        
        return $this->findByUser($user, $orderBy);
    }

    /**
     * Count vulnerabilities for a specific user's assets
     */
    public function countByUser(User $user): int
    {
        return $this->createQueryBuilder('v')
            ->select('COUNT(v.id)')
            ->join('v.asset', 'a')
            ->where('a.user = :user')
            ->setParameter('user', $user)
            ->getQuery()
            ->getSingleScalarResult();
    }

    /**
     * Count vulnerabilities by severity for a user's assets
     */
    public function countByUserAndSeverity(User $user): array
    {
        $results = $this->createQueryBuilder('v')
            ->select('v.severity, COUNT(v.id) as count')
            ->join('v.asset', 'a')
            ->where('a.user = :user')
            ->setParameter('user', $user)
            ->groupBy('v.severity')
            ->getQuery()
            ->getResult();

        $counts = [];
        foreach ($results as $result) {
            $counts[$result['severity']] = (int) $result['count'];
        }

        return $counts;
    }

    /**
     * Find vulnerabilities by asset for a user
     */
    public function findByAssetAndUser(Asset $asset, User $user): array
    {
        if (!$asset->canBeAccessedBy($user)) {
            return [];
        }

        return $this->findBy(['asset' => $asset], ['discoveredAt' => 'DESC']);
    }

    /**
     * Find critical vulnerabilities for a user
     */
    public function findCriticalByUser(User $user): array
    {
        return $this->createQueryBuilder('v')
            ->join('v.asset', 'a')
            ->where('a.user = :user')
            ->andWhere('v.severity = :severity')
            ->setParameter('user', $user)
            ->setParameter('severity', 'Critical')
            ->orderBy('v.discoveredAt', 'DESC')
            ->getQuery()
            ->getResult();
    }

    /**
     * Find vulnerabilities by status for a user
     */
    public function findByUserAndStatus(User $user, string $status): array
    {
        return $this->createQueryBuilder('v')
            ->join('v.asset', 'a')
            ->where('a.user = :user')
            ->andWhere('v.status = :status')
            ->setParameter('user', $user)
            ->setParameter('status', $status)
            ->orderBy('v.discoveredAt', 'DESC')
            ->getQuery()
            ->getResult();
    }

    /**
     * Check if user can access this vulnerability
     */
    public function canUserAccessVulnerability(Vulnerability $vulnerability, User $user): bool
    {
        return $vulnerability->getAsset()->canBeAccessedBy($user);
    }

    /**
     * Get vulnerability statistics for a user
     */
    public function getStatsByUser(User $user): array
    {
        $total = $this->countByUser($user);
        $bySeverity = $this->countByUserAndSeverity($user);
        
        $criticalCount = $bySeverity['Critical'] ?? 0;
        $highCount = $bySeverity['High'] ?? 0;
        $mediumCount = $bySeverity['Medium'] ?? 0;
        $lowCount = $bySeverity['Low'] ?? 0;

        return [
            'total' => $total,
            'by_severity' => $bySeverity,
            'critical_count' => $criticalCount,
            'high_count' => $highCount,
            'medium_count' => $mediumCount,
            'low_count' => $lowCount,
            'unresolved_count' => $this->countByUserAndStatus($user, 'Open')
        ];
    }

    /**
     * Count vulnerabilities by status for a user's assets
     */
    public function countByUserAndStatus(User $user, string $status): int
    {
        return $this->createQueryBuilder('v')
            ->select('COUNT(v.id)')
            ->join('v.asset', 'a')
            ->where('a.user = :user')
            ->andWhere('v.status = :status')
            ->setParameter('user', $user)
            ->setParameter('status', $status)
            ->getQuery()
            ->getSingleScalarResult();
    }

    /**
     * Find recent vulnerabilities for a user (last 30 days)
     */
    public function findRecentByUser(User $user, int $days = 30): array
    {
        $cutoffDate = new \DateTimeImmutable("-{$days} days");
        
        return $this->createQueryBuilder('v')
            ->join('v.asset', 'a')
            ->where('a.user = :user')
            ->andWhere('v.discoveredAt >= :cutoff')
            ->setParameter('user', $user)
            ->setParameter('cutoff', $cutoffDate)
            ->orderBy('v.discoveredAt', 'DESC')
            ->getQuery()
            ->getResult();
    }
}
