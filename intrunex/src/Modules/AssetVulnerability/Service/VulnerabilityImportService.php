<?php

namespace App\Modules\AssetVulnerability\Service;

use App\Modules\AssetDiscovery\Entity\Asset;
use App\Modules\ScanManagement\Entity\ScanJob;
use Doctrine\ORM\EntityManagerInterface;
use Psr\Log\LoggerInterface;

class VulnerabilityImportService
{
    private EntityManagerInterface $em;
    private LoggerInterface $logger;

    public function __construct(EntityManagerInterface $em, LoggerInterface $logger)
    {
        $this->em = $em;
        $this->logger = $logger;
    }

    /**
     * Import vulnerabilities from Nmap XML output.
     */
    public function importVulnerabilitiesFromNmapXml(string $xmlFilePath, Asset $asset, ScanJob $scanJob): void
    {
        if (!file_exists($xmlFilePath)) {
            $this->logger->error("XML file does not exist: $xmlFilePath");
            return;
        }

        $content = file_get_contents($xmlFilePath);

        if (!$content || strlen(trim($content)) === 0) {
            $this->logger->error("XML file is empty: $xmlFilePath");
            return;
        }

        // Correct XML loading
        $xml = @simplexml_load_string($content);

        if (!$xml) {
            $this->logger->error("Failed to parse Nmap XML output: String could not be parsed as XML");
            return;
        }

        // If needed parse ports
        foreach ($xml->host as $host) {
            if (!isset($host->ports)) {
                continue;
            }

            foreach ($host->ports->port as $port) {
                $portId  = (string) $port['portid'];
                $protocol = (string) $port['protocol'];
                $state    = (string) $port->state['state'];
                $service  = isset($port->service) ? (string) $port->service['name'] : 'unknown';

                $this->logger->info("Open port detected: $protocol/$portId => $service ($state)");
            }
        }

        $this->logger->info("Vulnerability import complete for ScanJob {$scanJob->getId()}.");
    }
}



