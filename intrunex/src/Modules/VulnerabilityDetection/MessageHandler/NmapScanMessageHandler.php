<?php

namespace App\Modules\VulnerabilityDetection\MessageHandler;

use App\Modules\AssetDiscovery\Entity\Asset;
use App\Modules\ScanManagement\Entity\ScanJob;
use App\Modules\AssetVulnerability\Service\VulnerabilityImportService;
use App\Modules\VulnerabilityDetection\Message\NmapScanMessage;
use App\Modules\VulnerabilityDetection\Service\NmapScanService;
use Doctrine\ORM\EntityManagerInterface;
use Psr\Log\LoggerInterface;
use Symfony\Component\Messenger\Attribute\AsMessageHandler;

#[AsMessageHandler]
class NmapScanMessageHandler
{
    private NmapScanService $nmapScanService;
    private VulnerabilityImportService $vulnerabilityImportService;
    private EntityManagerInterface $em;
    private LoggerInterface $logger;

    public function __construct(
        NmapScanService $nmapScanService,
        VulnerabilityImportService $vulnerabilityImportService,
        EntityManagerInterface $em,
        LoggerInterface $logger
    ) {
        $this->nmapScanService = $nmapScanService;
        $this->vulnerabilityImportService = $vulnerabilityImportService;
        $this->em = $em;
        $this->logger = $logger;
    }

    public function __invoke(NmapScanMessage $message): void
    {
        $asset = $this->em->getRepository(Asset::class)->find($message->getAssetId());
        $scanJob = $this->em->getRepository(ScanJob::class)->find($message->getScanJobId());

        if (!$asset || !$scanJob) {
            $this->logger->error(sprintf(
                "NmapScanMessageHandler: Asset (ID: %d) or ScanJob (ID: %d) not found.",
                $message->getAssetId(),
                $message->getScanJobId()
            ));
            return;
        }

        // mark as running
        $scanJob->setStatus('running');
        $scanJob->setStartedAt(new \DateTimeImmutable());
        $this->em->flush();

        $target = $asset->getIpAddress() ?? method_exists($asset, 'getHostname') ? $asset->getHostname() : null;
        $this->logger->info(sprintf("Nmap scan started for asset: %s (%s)", $asset->getName(), $target ?? 'Unknown target'));

        try {
            $xmlOutput = $this->nmapScanService->performScan($asset);

            if (empty($xmlOutput)) {
                $scanJob->setStatus('completed');
                $scanJob->setDetails('Nmap scan completed with no output.');
                $scanJob->setFinishedAt(new \DateTimeImmutable());
                $this->em->flush();
                $this->logger->warning(sprintf("Nmap scan for asset ID %d returned empty output.", $asset->getId()));
                return;
            }

            $this->vulnerabilityImportService->importVulnerabilitiesFromNmapXml($xmlOutput, $asset, $scanJob);

            $scanJob->setStatus('completed');
            $scanJob->setDetails(sprintf("Nmap scan completed for asset ID %d.", $asset->getId()));
            $scanJob->setFinishedAt(new \DateTimeImmutable());
            $this->em->flush();

            $this->logger->info(sprintf("Nmap scan completed for asset ID %d.", $asset->getId()));
        } catch (\Throwable $e) {
            $scanJob->setStatus('failed');
            $scanJob->setDetails(sprintf('Nmap scan failed for asset ID %d: %s', $asset->getId(), $e->getMessage()));
            $scanJob->setFinishedAt(new \DateTimeImmutable());
            $this->em->flush();

            $this->logger->error(sprintf('Nmap scan failed for asset ID %d: %s', $asset->getId(), $e->getMessage()));
            // rethrow if you want Messenger to handle retries, otherwise swallow after logging
            throw $e;
        }
    }
}


