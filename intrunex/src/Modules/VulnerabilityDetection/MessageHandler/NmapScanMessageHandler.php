<?php

namespace App\Modules\VulnerabilityDetection\MessageHandler;

use App\Entity\Asset;
use App\Entity\ScanJob;
use App\Modules\AssetVulnerability\Service\VulnerabilityImportService;
use App\Modules\VulnerabilityDetection\Message\NmapScanMessage;
use App\Modules\VulnerabilityDetection\Service\NmapScanService;
use Doctrine\ORM\EntityManagerInterface;
use Psr\Log\LoggerInterface;
use Symfony\Component\Messenger\Attribute\AsMessageHandler;

#[AsMessageHandler]
class NmapScanMessageHandler
{
    private NmapScanService $nmapScanService;
    private VulnerabilityImportService $vulnerabilityImportService;
    private EntityManagerInterface $em;
    private LoggerInterface $logger;

    public function __construct(
        NmapScanService $nmapScanService,
        VulnerabilityImportService $vulnerabilityImportService,
        EntityManagerInterface $em,
        LoggerInterface $logger
    ) {
        $this->nmapScanService = $nmapScanService;
        $this->vulnerabilityImportService = $vulnerabilityImportService;
        $this->em = $em;
        $this->logger = $logger;
    }

    public function __invoke(NmapScanMessage $message): void
    {
        $asset = $this->em->getRepository(Asset::class)->find($message->getAssetId());
        $scanJob = $this->em->getRepository(ScanJob::class)->find($message->getScanJobId());

        if (!$asset || !$scanJob) {
            $this->logger->error(sprintf(
                "NmapScanMessageHandler: Asset (ID: %d) or ScanJob (ID: %d) not found.",
                $message->getAssetId(),
                $message->getScanJobId()
            ));
            return;
        }

        $target = $asset->getIpAddress() ?? $asset->getHostname();
        $this->logger->info(sprintf("Nmap scan started for asset: %s (%s)", $asset->getName(), isset($target) ? $target : 'Unknown target'));

        try {
            $xmlOutput = $this->nmapScanService->performScan($asset);

            if (empty($xmlOutput)) {
                $this->logger->warning(sprintf("Nmap scan for asset ID %d returned empty output.", $asset->getId()));
                $scanJob->setStatus('completed');
                $scanJob->setDetails('Nmap scan completed with no output.');
                $this->em->flush();
                return;
            }

            $this->vulnerabilityImportService->importVulnerabilitiesFromNmapXml($xmlOutput, $asset, $scanJob);

            $scanJob->setStatus('completed');
            $scanJob->setDetails(sprintf(
                "Nmap scan completed for asset ID %d.",
                $asset->getId()
            ));
            $this->em->flush();
            $this->logger->info(sprintf("Nmap scan completed for asset ID %d.", $asset->getId()));

        } catch (\Exception $e) {
            $scanJob->setStatus('failed');
            $scanJob->setDetails(sprintf('Nmap scan failed for asset ID %d: %s', $asset->getId(), $e->getMessage()));
            $this->em->flush();
            $this->logger->error(sprintf('Nmap scan failed for asset ID %d: %s', $asset->getId(), $e->getMessage()));
        }
    }
}
