<?php

namespace App\Modules\VulnerabilityDetection\MessageHandler;

use App\Modules\AssetDiscovery\Entity\Asset;
use App\Modules\ScanManagement\Entity\ScanJob;
use App\Modules\AssetVulnerability\Service\VulnerabilityImportService;
use App\Modules\VulnerabilityDetection\Message\NmapScanMessage;
use App\Modules\VulnerabilityDetection\Service\NmapScanService;
use Doctrine\ORM\EntityManagerInterface;
use Psr\Log\LoggerInterface;
use Symfony\Component\Messenger\Attribute\AsMessageHandler;

#[AsMessageHandler]
class NmapScanMessageHandler
{
    private NmapScanService $nmapScanService;
    private VulnerabilityImportService $vulnerabilityImportService;
    private EntityManagerInterface $em;
    private LoggerInterface $logger;

    public function __construct(
        NmapScanService $nmapScanService,
        VulnerabilityImportService $vulnerabilityImportService,
        EntityManagerInterface $em,
        LoggerInterface $logger
    ) {
        $this->nmapScanService = $nmapScanService;
        $this->vulnerabilityImportService = $vulnerabilityImportService;
        $this->em = $em;
        $this->logger = $logger;
    }

    public function __invoke(NmapScanMessage $message): void
    {
        $asset = $this->em->getRepository(Asset::class)->find($message->getAssetId());
        $scanJob = $this->em->getRepository(ScanJob::class)->find($message->getScanJobId());

        if (!$asset || !$scanJob) {
            $this->logger->error(sprintf(
                "NmapScanMessageHandler: Asset (ID: %d) or ScanJob (ID: %d) not found.",
                $message->getAssetId(),
                $message->getScanJobId()
            ));
            return;
        }

        /**
         * Mark job as running
         */
        $scanJob->setStatus('running');
        $scanJob->setStartedAt(new \DateTimeImmutable());
        $this->em->flush();

        /**
         * FIXED: Correct target resolver
         */
        $target =
            $asset->getIpAddress()
            ?? $asset->getDomain()
            ?? $asset->getUrl()
            ?? null;

        if (!$target) {
            $scanJob->setStatus('failed');
            $scanJob->setDetails('No valid target (IP/Domain/URL) found for Nmap scan.');
            $scanJob->setFinishedAt(new \DateTimeImmutable());
            $this->em->flush();

            $this->logger->error(
                "NmapScanMessageHandler: No valid target found for asset ID {$asset->getId()}"
            );
            return;
        }

        $this->logger->info(sprintf(
            "Nmap scan started for asset: %s (%s)",
            $asset->getName(),
            $target
        ));

        try {
            /**
             * Execute scanner
             */
            $xmlOutput = $this->nmapScanService->performScan($asset);

            if (empty($xmlOutput)) {
                $scanJob->setStatus('completed');
                $scanJob->setDetails('Nmap scan completed with no output.');
                $scanJob->setFinishedAt(new \DateTimeImmutable());
                $this->em->flush();

                $this->logger->warning(
                    "Nmap scan for asset ID {$asset->getId()} returned empty output."
                );
                return;
            }

            /**
             * Import vulnerabilities
             */
            $this->vulnerabilityImportService->importVulnerabilitiesFromNmapXml(
                $xmlOutput,
                $asset,
                $scanJob
            );

            /**
             * Successfully completed
             */
            $scanJob->setStatus('completed');
            $scanJob->setDetails("Nmap scan completed for asset ID {$asset->getId()}");
            $scanJob->setFinishedAt(new \DateTimeImmutable());
            $this->em->flush();

            $this->logger->info(
                "Nmap scan completed for asset ID {$asset->getId()}."
            );

        } catch (\Throwable $e) {
            /**
             * Mark failure
             */
            $scanJob->setStatus('failed');
            $scanJob->setDetails(
                "Nmap scan failed for asset ID {$asset->getId()}: " . $e->getMessage()
            );
            $scanJob->setFinishedAt(new \DateTimeImmutable());
            $this->em->flush();

            $this->logger->error(
                "Nmap scan failed for asset ID {$asset->getId()}: {$e->getMessage()}"
            );

            throw $e; // allow Messenger retry
        }
    }
}




