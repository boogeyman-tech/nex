<?php

namespace App\Modules\VulnerabilityDetection\Service;

use App\Modules\AssetDiscovery\Entity\Asset;
use Psr\Log\LoggerInterface;

class NmapScanService
{
    private LoggerInterface $logger;

    public function __construct(LoggerInterface $logger)
    {
        $this->logger = $logger;
    }

    public function performScan(Asset $asset): string
    {
        $target = $asset->getIpAddress() ?: $asset->getDomain();

        if (!$target) {
            throw new \RuntimeException("No valid scan target found for asset ID {$asset->getId()}");
        }

        $this->logger->info("Starting Nmap scan for: {$asset->getName()} ({$target})");

        // Output file
        $xmlFile = '/tmp/nmap_' . uniqid() . '.xml';

        // ðŸŸ© ENABLE NSE SCRIPTS HERE (safe scripts)
        $nmapArgs = [
            'nmap',
            '-sV',            // service detection
            '-T4',            // faster timing
            '--script=safe',  // enable NSE safe scripts
            '-oX', $xmlFile,  // output XML
            $target,
        ];

        $this->logger->info("Executing Nmap command: " . implode(' ', array_map('escapeshellarg', $nmapArgs)));

        $process = proc_open(
            $nmapArgs,
            [
                1 => ['pipe', 'w'], // stdout
                2 => ['pipe', 'w'], // stderr
            ],
            $pipes
        );

        if (!\is_resource($process)) {
            throw new \RuntimeException("Failed to execute Nmap process.");
        }

        $stdout = stream_get_contents($pipes[1]);
        $stderr = stream_get_contents($pipes[2]);

        fclose($pipes[1]);
        fclose($pipes[2]);

        $exitCode = proc_close($process);

        if ($exitCode !== 0) {
            $this->logger->error("Nmap failed with exit code {$exitCode}. Stderr: {$stderr}");
            throw new \RuntimeException("Nmap scan failed for $target. Stderr: $stderr");
        }

        $this->logger->info("Nmap scan completed successfully for target {$target}.");

        return $xmlFile; // Return file path â€” NOT the XML string
    }
}




