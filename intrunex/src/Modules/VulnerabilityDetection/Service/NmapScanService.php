<?php

namespace App\Modules\VulnerabilityDetection\Service;

use App\Modules\AssetDiscovery\Entity\Asset;
use Psr\Log\LoggerInterface;

class NmapScanService
{
    private LoggerInterface $logger;
    private string $tempDir;

    public function __construct(LoggerInterface $logger, string $tempDir = '/tmp')
    {
        $this->logger = $logger;
        $this->tempDir = $tempDir;
    }

    /**
     * Perform an Nmap scan without OS detection (-O)
     * because OS scan requires raw-socket privileges (root).
     */
    public function performScan(Asset $asset): ?string
    {
        $target = $asset->getIpAddress();

        if (!$target) {
            $this->logger->error("NmapScanService: No valid target for asset ID {$asset->getId()}");
            return null;
        }

        $this->logger->info(sprintf(
            "Starting Nmap scan for: %s (%s)",
            $asset->getName(),
            $target
        ));

        // Create temp file for XML output
        $xmlPath = $this->tempDir . '/nmap_' . uniqid() . '.xml';

        /**
         * IMPORTANT CHANGE:
         * Removed `-O` (OS Detection) because it requires root.
         */
        $command = [
            'nmap',
            '-sV',          // service version enumeration
            '-T4',          // faster timing
            '-oX', $xmlPath,
            $target
        ];

        $cmdString = implode(' ', array_map('escapeshellarg', $command));
        $this->logger->info("Executing Nmap command: $cmdString");

        // Run command
        exec($cmdString . " 2>&1", $output, $exitCode);

        if ($exitCode !== 0) {
            $stderr = implode("\n", $output);

            $this->logger->error("Nmap scan failed with exit code $exitCode. Stderr: $stderr");

            // Throw exception so message handler can update ScanJob status
            throw new \RuntimeException(
                "Nmap scan failed for $target. Stderr: $stderr"
            );
        }

        if (!file_exists($xmlPath) || filesize($xmlPath) === 0) {
            $this->logger->warning("Nmap XML output missing or empty for target $target.");
            return null;
        }

        $this->logger->info("Nmap scan completed successfully for target $target.");
        return $xmlPath;
    }
}




