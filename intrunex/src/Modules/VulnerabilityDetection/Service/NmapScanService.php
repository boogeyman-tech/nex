<?php

namespace App\Modules\VulnerabilityDetection\Service;

use App\Entity\Asset;
use App\Entity\ScanJob;
use Doctrine\ORM\EntityManagerInterface;
use Psr\Log\LoggerInterface;
use Symfony\Component\Messenger\MessageBusInterface;

class NmapScanService
{
    private EntityManagerInterface $em;
    private LoggerInterface $logger;
    private MessageBusInterface $bus;
    private string $nmapBinary;

    public function __construct(EntityManagerInterface $em, LoggerInterface $logger, MessageBusInterface $bus, string $nmapBinary = 'nmap')
    {
        $this->em = $em;
        $this->logger = $logger;
        $this->bus = $bus;
        $this->nmapBinary = $nmapBinary;
    }

    public function performScan(Asset $asset): string
    {
        $target = $asset->getIpAddress() ?? $asset->getHostname();
        if (!$target) {
            throw new \InvalidArgumentException('Asset must have an IP address or hostname to scan.');
        }

        $this->logger->info("Starting Nmap scan for: {$asset->getName()} ({$target})");

        // Create a temporary file for Nmap XML output
        $outputFile = sys_get_temp_dir() . '/nmap_' . uniqid() . '.xml';

        // Nmap command to scan for common vulnerabilities and output in XML format
        // -sV: Probe open ports to determine service/version info
        // -O: Enable OS detection
        // -T4: Set timing template (4 is aggressive)
        // -oX: Output scan in XML to the specified file
        $command = sprintf(
            '%s -sV -O -T4 -oX %s %s',
            $this->nmapBinary,
            escapeshellarg($outputFile),
            escapeshellarg($target)
        );

        $this->logger->info("Executing Nmap command: {$command}");
        $process = proc_open($command, [
            1 => ['pipe', 'w'], // stdout
            2 => ['pipe', 'w'], // stderr
        ], $pipes);

        if (!is_resource($process)) {
            throw new \RuntimeException('Failed to start Nmap process.');
        }

        $stdout = stream_get_contents($pipes[1]);
        $stderr = stream_get_contents($pipes[2]);
        fclose($pipes[1]);
        fclose($pipes[2]);

        $exitCode = proc_close($process);

        if ($exitCode !== 0) {
            $this->logger->error("Nmap scan failed with exit code {$exitCode}. Stderr: {$stderr}");
            throw new \RuntimeException("Nmap scan failed for {$target}. Stderr: {$stderr}");
        }

        if (!file_exists($outputFile)) {
            throw new \RuntimeException('Nmap scan did not produce an output file.');
        }

        $xmlOutput = file_get_contents($outputFile);
        unlink($outputFile); // Clean up the temporary file

        return $xmlOutput;
    }
}
